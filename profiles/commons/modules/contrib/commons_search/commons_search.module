<?php
/**
 * commons_search.module
 * Code for the Commons Search feature.
 */

include_once 'commons_search.features.inc';

/**
 * Implements hook_module_implements_alter().
 */
function commons_search_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'form_alter') {
    // We move commons_search to the end so it gets processed last.
    $group = $implementations['commons_search'];
    unset($implementations['commons_search']);
    $implementations['commons_search'] = $group;
  }
}

/**
 * Custom search form that switches between Core and Solr depending on which is
 * the enabled search module.
 */
function commons_search_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'search_block_form') {
    // Move the textfield to after the drop down.
    $site_key = 'c-all';
    $form['search_block_form']['#weight'] = 1;
    if (module_exists('apachesolr_search')) {
      $site_key = 'o-solr';
    }
    $form['custom_search_types']['#options'] = array(
      $site_key => t('Site'),
      'c-user' => t('Users'),
    );
    $group = FALSE;
    $node = current_path();
    if (strpos($node, 'node/') !== FALSE
      && is_numeric(substr($node, strpos($node, '/')+1))) {
      $node = node_load(substr($node, strpos($node, '/')+1));
      $group = ($node->type == 'group');
    }
    if ($group) {
      $form['custom_search_types']['#options']['o-commons_search'] = t('Group');
      $form_state['search_group_id'] = $node->nid;
      $form['#submit'][] = 'commons_search_search_form_submit';
    }
  }
}

/**
 * Search form submit handler.
 * Add group id filter if appropriate.
 */
function commons_search_search_form_submit($form, &$form_state) {
  if (isset($form_state['search_group_id'])) {
    if (module_exists('apachesolr_search')) {
      $form_state['redirect'] .= '&f[1]=sm_og_group_ref:node:' . $form_state['search_group_id'];
    }
    else {
      $form_state['redirect'] = 'search/group/' . $form_state['search_group_id'];
    }
  }
}
